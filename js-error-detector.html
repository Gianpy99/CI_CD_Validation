<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>JavaScript Error Detector</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .error { color: red; background: #ffe6e6; padding: 5px; margin: 5px 0; }
        .info { color: blue; background: #e6f3ff; padding: 5px; margin: 5px 0; }
        .success { color: green; background: #e6ffe6; padding: 5px; margin: 5px 0; }
        #log { max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        button { padding: 8px 16px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>JavaScript Error Detector per Pytest Report</h1>
    
    <button onclick="loadAndTestPytestReport()">Load and Test Pytest Report</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div id="log"></div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class=\"${className}\">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Override console methods to catch errors
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.error = function(...args) {
            log(`CONSOLE ERROR: ${args.join(' ')}`, 'error');
            originalConsoleError.apply(console, args);
        };
        
        console.warn = function(...args) {
            log(`CONSOLE WARNING: ${args.join(' ')}`, 'info');
            originalConsoleWarn.apply(console, args);
        };
        
        // Catch global errors
        window.addEventListener('error', function(event) {
            log(`GLOBAL ERROR: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            log(`UNHANDLED PROMISE REJECTION: ${event.reason}`, 'error');
        });
        
        function loadAndTestPytestReport() {
            log('Starting pytest report analysis...', 'info');
            
            // Load pytest report in an iframe to test its JavaScript
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.onload = function() {
                log('Pytest report loaded in iframe', 'success');
                
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const iframeWindow = iframe.contentWindow;
                    
                    log('Iframe document accessible', 'success');
                    
                    // Check if buttons exist
                    const showBtn = iframeDoc.getElementById('show_all_details');
                    const hideBtn = iframeDoc.getElementById('hide_all_details');
                    
                    log(`Show button exists: ${!!showBtn}`, showBtn ? 'success' : 'error');
                    log(`Hide button exists: ${!!hideBtn}`, hideBtn ? 'success' : 'error');
                    
                    if (showBtn && hideBtn) {
                        // Try to click the buttons
                        log('Attempting to click show button...', 'info');
                        
                        // Override iframe console to catch errors
                        if (iframeWindow.console) {
                            const originalIframeError = iframeWindow.console.error;
                            iframeWindow.console.error = function(...args) {
                                log(`IFRAME ERROR: ${args.join(' ')}`, 'error');
                                originalIframeError.apply(iframeWindow.console, args);
                            };
                        }
                        
                        // Add error listener to iframe
                        iframeWindow.addEventListener('error', function(event) {
                            log(`IFRAME GLOBAL ERROR: ${event.message}`, 'error');
                        });
                        
                        // Try clicking
                        try {
                            showBtn.click();
                            log('Show button clicked successfully', 'success');
                            
                            setTimeout(() => {
                                try {
                                    hideBtn.click();
                                    log('Hide button clicked successfully', 'success');
                                } catch (e) {
                                    log(`Error clicking hide button: ${e.message}`, 'error');
                                }
                            }, 1000);
                            
                        } catch (e) {
                            log(`Error clicking show button: ${e.message}`, 'error');
                        }
                    }
                    
                    // Check for JavaScript errors in the iframe
                    setTimeout(() => {
                        const collapsibles = iframeDoc.querySelectorAll('.collapsible');
                        log(`Found ${collapsibles.length} collapsible elements`, 'info');
                        
                        // Check if manager object exists
                        if (iframeWindow.manager) {
                            log('Manager object exists in iframe', 'success');
                        } else {
                            log('Manager object NOT found in iframe', 'error');
                        }
                        
                        // Remove iframe after test
                        setTimeout(() => {
                            document.body.removeChild(iframe);
                            log('Test completed, iframe removed', 'info');
                        }, 2000);
                    }, 2000);
                    
                } catch (e) {
                    log(`Error accessing iframe content: ${e.message}`, 'error');
                }
            };
            
            iframe.onerror = function() {
                log('Error loading pytest report in iframe', 'error');
            };
            
            iframe.src = 'pytest-report-test.html';
            document.body.appendChild(iframe);
        }
    </script>
</body>
</html>
