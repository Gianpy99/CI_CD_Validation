<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Pytest Button Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        button { padding: 8px 16px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a87; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        .collapsible { display: none; background: #f9f9f9; padding: 10px; margin: 5px 0; }
        .test-item { margin: 5px 0; padding: 5px; border: 1px solid #ddd; }
        #debug-log { max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Test Replica del Pulsante Pytest</h1>
    
    <div class="test-section">
        <h2>Test con ID esatti come pytest-html</h2>
        <button id="show_all_details">Show all details</button>&nbsp;/&nbsp;<button id="hide_all_details">Hide all details</button>
        
        <div class="test-item">
            <h3>Test 1</h3>
            <div class="collapsible" data-test-id="test-1">
                <p>Dettagli del Test 1</p>
                <pre>assert add(2, 3) == 5</pre>
            </div>
        </div>
        
        <div class="test-item">
            <h3>Test 2</h3>
            <div class="collapsible" data-test-id="test-2">
                <p>Dettagli del Test 2</p>
                <pre>assert subtract(5, 3) == 2</pre>
            </div>
        </div>
    </div>
    
    <div class="debug">
        <h3>Debug Log:</h3>
        <div id="debug-log"></div>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="testManualToggle()">Test Manual Toggle</button>
    </div>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const debugLog = document.getElementById('debug-log');
            debugLog.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }
        
        function testManualToggle() {
            log('Manual toggle test started');
            const collapsibles = document.getElementsByClassName('collapsible');
            
            for (let i = 0; i < collapsibles.length; i++) {
                const current = collapsibles[i].style.display;
                const newDisplay = current === 'block' ? 'none' : 'block';
                collapsibles[i].style.display = newDisplay;
                log(`Element ${i}: ${current} -> ${newDisplay}`);
            }
        }
        
        // Replica esatta del comportamento pytest-html
        class TestManager {
            constructor() {
                this.renderData = {
                    tests: [
                        { id: 'test-1' },
                        { id: 'test-2' }
                    ]
                };
                log('TestManager created');
            }
            
            set allCollapsed(collapsed) {
                log(`allCollapsed setter called with: ${collapsed}`);
                const collapsibles = document.getElementsByClassName('collapsible');
                
                for (let i = 0; i < collapsibles.length; i++) {
                    collapsibles[i].style.display = collapsed ? 'none' : 'block';
                    log(`Element ${i} display set to: ${collapsed ? 'none' : 'block'}`);
                }
            }
        }
        
        function setCollapsedIds(ids) {
            log(`setCollapsedIds called with: ${JSON.stringify(ids)}`);
            // Questa funzione nel pytest originale gestisce lo stato collapsed
        }
        
        // Inizializzazione
        const manager = new TestManager();
        
        // Event listeners esatti come nel pytest-html
        document.getElementById('show_all_details').addEventListener('click', () => {
            log('Show all details button clicked');
            manager.allCollapsed = false;
        });
        
        document.getElementById('hide_all_details').addEventListener('click', () => {
            log('Hide all details button clicked');
            manager.allCollapsed = true;
            const allIds = manager.renderData.tests.map((test) => test.id);
            setCollapsedIds(allIds);
        });
        
        // Test di verifica al caricamento
        window.addEventListener('load', function() {
            log('Page loaded - running verification tests');
            
            // Verifica che i pulsanti esistano
            const showBtn = document.getElementById('show_all_details');
            const hideBtn = document.getElementById('hide_all_details');
            
            log(`Show button exists: ${showBtn !== null}`);
            log(`Hide button exists: ${hideBtn !== null}`);
            
            if (showBtn) {
                log(`Show button innerHTML: "${showBtn.innerHTML}"`);
                log(`Show button onclick: ${showBtn.onclick}`);
            }
            
            // Verifica elementi collapsible
            const collapsibles = document.getElementsByClassName('collapsible');
            log(`Found ${collapsibles.length} collapsible elements`);
            
            for (let i = 0; i < collapsibles.length; i++) {
                log(`Collapsible ${i}: display = "${collapsibles[i].style.display}"`);
            }
            
            // Test automatico dopo 3 secondi
            setTimeout(() => {
                log('=== STARTING AUTOMATIC TEST ===');
                log('Clicking show button...');
                showBtn.click();
                
                setTimeout(() => {
                    log('Clicking hide button...');
                    hideBtn.click();
                    log('=== AUTOMATIC TEST COMPLETED ===');
                }, 2000);
            }, 3000);
        });
    </script>
</body>
</html>
